{% extends "base.html" %}

{% block title %}Advanced Analytics - BBSchedule Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Analytics Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Advanced Analytics
                    </h1>
                    <p class="text-muted mb-0">Comprehensive project performance insights</p>
                </div>
                <div>
                    <select class="form-select me-2" id="dateRange" style="width: auto; display: inline-block;">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                    <button class="btn btn-primary" id="refreshAnalytics">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-primary rounded-circle me-3">
                            <i class="fas fa-project-diagram text-white"></i>
                        </div>
                        <div>
                            <h6 class="card-title mb-0">Project Performance</h6>
                            <div class="metric-value" id="projectPerformance">85%</div>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>12% from last month
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-success rounded-circle me-3">
                            <i class="fas fa-tasks text-white"></i>
                        </div>
                        <div>
                            <h6 class="card-title mb-0">Task Completion</h6>
                            <div class="metric-value" id="taskCompletion">92%</div>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>8% improvement
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-warning rounded-circle me-3">
                            <i class="fas fa-dollar-sign text-white"></i>
                        </div>
                        <div>
                            <h6 class="card-title mb-0">Budget Variance</h6>
                            <div class="metric-value" id="budgetVariance">-2.3%</div>
                            <small class="text-success">
                                <i class="fas fa-arrow-down me-1"></i>Under budget
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="metric-icon bg-info rounded-circle me-3">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div>
                            <h6 class="card-title mb-0">Team Productivity</h6>
                            <div class="metric-value" id="teamProductivity">78%</div>
                            <small class="text-warning">
                                <i class="fas fa-minus me-1"></i>Stable
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Project Performance Trends -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Project Performance Trends
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="performanceTrendChart" height="80"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Resource Utilization -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Resource Utilization
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="resourceChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics -->
    <div class="row g-4 mb-4">
        <!-- Task Analytics -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-list-check me-2"></i>
                        Task Analytics
                    </h6>
                </div>
                <div class="card-body">
                    <div id="taskAnalyticsContent">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Critical Path Analysis -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-route me-2"></i>
                        Critical Path Tasks
                    </h6>
                </div>
                <div class="card-body">
                    <div id="criticalPathContent">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Productivity (Admin Only) -->
    {% if current_user.role.name == 'ADMIN' %}
    <div class="row g-4 mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-users-cog me-2"></i>
                        User Productivity Analysis
                    </h6>
                </div>
                <div class="card-body">
                    <div id="userProductivityContent">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Optimization Recommendations -->
    <div class="row g-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        AI-Powered Recommendations
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="recommendation-card">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="recommendation-icon bg-success me-2">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <strong>Schedule Optimization</strong>
                                </div>
                                <p class="small mb-0">Parallel task execution could reduce project timeline by 8%</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="recommendation-card">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="recommendation-icon bg-info me-2">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <strong>Resource Allocation</strong>
                                </div>
                                <p class="small mb-0">Equipment utilization can be improved by 15% with better scheduling</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="recommendation-card">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="recommendation-icon bg-warning me-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <strong>Risk Mitigation</strong>
                                </div>
                                <p class="small mb-0">3 projects have high delay risk - add buffer time to critical tasks</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Analytics Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadAnalyticsData();
    
    // Event listeners
    document.getElementById('refreshAnalytics').addEventListener('click', loadAnalyticsData);
    document.getElementById('dateRange').addEventListener('change', loadAnalyticsData);
});

function initializeCharts() {
    // Performance Trend Chart
    const performanceCtx = document.getElementById('performanceTrendChart').getContext('2d');
    window.performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Budget Performance',
                data: [85, 88, 92, 89],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.1
            }, {
                label: 'Schedule Performance',
                data: [78, 82, 85, 87],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Resource Utilization Chart
    const resourceCtx = document.getElementById('resourceChart').getContext('2d');
    window.resourceChart = new Chart(resourceCtx, {
        type: 'doughnut',
        data: {
            labels: ['Labor', 'Equipment', 'Materials'],
            datasets: [{
                data: [78, 65, 89],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

async function loadAnalyticsData() {
    try {
        const dateRange = document.getElementById('dateRange').value;
        
        // Load project performance metrics
        const performanceResponse = await fetch(`/api/analytics/project-performance?days=${dateRange}`);
        const performanceData = await performanceResponse.json();
        updatePerformanceMetrics(performanceData);
        
        // Load task analytics
        const taskResponse = await fetch('/api/analytics/task-analytics');
        const taskData = await taskResponse.json();
        updateTaskAnalytics(taskData);
        
        // Load user productivity (admin only)
        if (document.getElementById('userProductivityContent')) {
            const productivityResponse = await fetch('/api/analytics/user-productivity');
            if (productivityResponse.ok) {
                const productivityData = await productivityResponse.json();
                updateUserProductivity(productivityData);
            }
        }
        
    } catch (error) {
        console.error('Analytics loading error:', error);
        showErrorMessage('Failed to load analytics data');
    }
}

function updatePerformanceMetrics(data) {
    // Update metric cards
    const budgetVariance = data.budget_performance?.variance_percent || 0;
    document.getElementById('budgetVariance').textContent = `${budgetVariance.toFixed(1)}%`;
    
    const scheduleAdherence = data.schedule_performance?.schedule_adherence_percent || 0;
    document.getElementById('projectPerformance').textContent = `${scheduleAdherence.toFixed(0)}%`;
}

function updateTaskAnalytics(data) {
    const content = document.getElementById('taskAnalyticsContent');
    
    let html = `
        <div class="row g-3">
            <div class="col-6">
                <div class="text-center">
                    <div class="h4 mb-0">${data.total_tasks || 0}</div>
                    <small class="text-muted">Total Tasks</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="h4 mb-0">${data.completion_rate?.toFixed(1) || 0}%</div>
                    <small class="text-muted">Completion Rate</small>
                </div>
            </div>
        </div>
        <hr>
        <div class="mb-3">
            <h6>Status Distribution</h6>
    `;
    
    if (data.status_distribution) {
        Object.entries(data.status_distribution).forEach(([status, count]) => {
            const percentage = ((count / data.total_tasks) * 100).toFixed(1);
            html += `
                <div class="d-flex justify-content-between mb-1">
                    <small>${status.replace('_', ' ')}</small>
                    <small>${count} (${percentage}%)</small>
                </div>
            `;
        });
    }
    
    html += '</div>';
    
    if (data.critical_path_tasks && data.critical_path_tasks.length > 0) {
        const criticalContent = document.getElementById('criticalPathContent');
        let criticalHtml = '<div class="list-group list-group-flush">';
        
        data.critical_path_tasks.forEach(task => {
            criticalHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-medium">${task.name}</div>
                        <small class="text-muted">${task.project_name}</small>
                    </div>
                    <small class="badge bg-warning">${task.end_date}</small>
                </div>
            `;
        });
        
        criticalHtml += '</div>';
        criticalContent.innerHTML = criticalHtml;
    }
    
    content.innerHTML = html;
}

function updateUserProductivity(data) {
    const content = document.getElementById('userProductivityContent');
    
    let html = `
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="text-center">
                    <div class="h4 mb-0">${data.total_users || 0}</div>
                    <small class="text-muted">Total Users</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="text-center">
                    <div class="h4 mb-0">${data.active_users_30_days || 0}</div>
                    <small class="text-muted">Active This Month</small>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Projects</th>
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (data.user_details) {
        data.user_details.forEach(user => {
            html += `
                <tr>
                    <td>${user.username}</td>
                    <td><span class="badge bg-secondary">${user.role}</span></td>
                    <td>${user.projects_managed}</td>
                    <td>${user.monthly_activity}</td>
                </tr>
            `;
        });
    }
    
    html += '</tbody></table></div>';
    content.innerHTML = html;
}

function showErrorMessage(message) {
    // Simple error display
    console.error(message);
}
</script>

<style>
.metric-card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
}

.recommendation-card {
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    height: 100%;
}

.recommendation-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
</style>
{% endblock %}